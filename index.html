<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>보스게이트 - 초안정 v4.1 (저장/삭제 메뉴 추가)</title>
  <style>
    :root{
      --bg:#070a12;
      --panel: rgba(12,18,38,0.88);
      --line: rgba(255,255,255,0.12);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --good:#6ae37b;
      --warn:#ffd36a;
      --bad:#ff6a6a;
      --btn1:#243a77;
      --btn2:#1b2a55;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --r:18px;
      --font: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", Segoe UI, Roboto, Arial, sans-serif;
    }

    html, body{
      margin:0; padding:0;
      width:100%; height:100%;
      overflow:hidden;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }

    #app{
      position:fixed; inset:0;
      width:100vw; height:100vh;
      background: radial-gradient(1200px 900px at 30% 20%, #121b3a 0%, #070a12 55%, #050610 100%);
      overflow:hidden;
    }

    /* 캔버스는 그리기만 하고 입력은 HUD가 받게 */
    #cv{
      position:absolute; inset:0;
      width:100%; height:100%;
      display:block;
      background: transparent;
      pointer-events:none;
    }

    /* HUD는 항상 클릭 가능 */
    #hud{
      position:absolute; inset:0;
      pointer-events:auto;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .panel{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .topbar{
      position:absolute;
      left:12px; right:12px; top:12px;
      display:flex;
      gap:10px;
      align-items:stretch;
      justify-content:space-between;
      z-index: 10;
    }

    .status{
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 260px;
    }
    .status .title{ font-weight:900; font-size:13px; letter-spacing:-0.2px; }
    .status .meta{
      display:flex; flex-wrap:wrap;
      gap:10px;
      font-size:12px;
      color: var(--muted);
      letter-spacing:-0.2px;
      align-items:center;
    }

    .btnRow{
      display:flex;
      gap:8px;
      padding:8px;
      align-items:center;
    }

    button{
      appearance:none;
      border:none;
      background:none;
      color:inherit;
      font:inherit;
    }

    .btn{
      border: 1px solid rgba(255,255,255,0.14);
      background: linear-gradient(180deg, var(--btn1), var(--btn2));
      color: var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      font-size:13px;
      letter-spacing:-0.2px;
      cursor:pointer;
      touch-action: manipulation;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-height: 40px;
      box-shadow: 0 10px 18px rgba(0,0,0,0.22);
    }
    .btn.small{ padding:9px 10px; min-height:36px; font-size:12px; border-radius:12px; }
    .btn.ghost{ background: rgba(255,255,255,0.06); box-shadow:none; }
    .btn.bad{ background: linear-gradient(180deg, rgba(255,106,106,0.25), rgba(255,106,106,0.16)); border-color: rgba(255,106,106,0.28); }
    .btn.good{ background: linear-gradient(180deg, rgba(106,227,123,0.22), rgba(106,227,123,0.14)); border-color: rgba(106,227,123,0.28); }
    .btn.warn{ background: linear-gradient(180deg, rgba(255,211,106,0.22), rgba(255,211,106,0.12)); border-color: rgba(255,211,106,0.28); }
    .btn.on{ outline:2px solid rgba(106,167,255,0.55); border-color: rgba(106,167,255,0.55); }
    .btn:active{ transform: translateY(1px); }

    .chip{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    .chip.good{ color: rgba(106,227,123,0.95); border-color: rgba(106,227,123,0.28); }
    .chip.warn{ color: rgba(255,211,106,0.95); border-color: rgba(255,211,106,0.30); }
    .chip.bad{  color: rgba(255,106,106,0.95); border-color: rgba(255,106,106,0.30); }

    .bottombar{
      position:absolute;
      left:12px; right:12px; bottom:12px;
      display:flex;
      gap:12px;
      align-items:flex-end;
      justify-content:space-between;
      z-index: 10;
    }

    .joystick{
      width: 140px; height: 140px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      position:relative;
      touch-action:none;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .stick{
      width:64px; height:64px;
      border-radius:999px;
      background: rgba(255,255,255,0.12);
      border:1px solid rgba(255,255,255,0.20);
      box-shadow: 0 12px 26px rgba(0,0,0,0.28);
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    .col{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:stretch;
    }

    .toastWrap{
      position:absolute;
      left:50%;
      bottom:190px;
      transform: translateX(-50%);
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
      pointer-events:none;
      z-index: 20;
      max-width: min(520px, calc(100vw - 24px));
    }
    .toast{
      background: rgba(0,0,0,0.58);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 13px;
      color: rgba(255,255,255,0.92);
      backdrop-filter: blur(8px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
      opacity:0;
      transform: translateY(6px);
      transition: opacity .18s ease, transform .18s ease;
      text-align:center;
      line-height:1.25;
      word-break: keep-all;
    }
    .toast.show{ opacity:1; transform: translateY(0); }
    .toast b{ color:#fff; }

    .modal{
      position:absolute; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,0.55);
      z-index: 30;
      padding:18px;
    }
    .modal.show{ display:flex; }
    .modalCard{
      width:min(920px, 100%);
      max-height:min(82vh, 920px);
      overflow:auto;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(12,18,38,0.92);
      backdrop-filter: blur(14px);
      box-shadow: 0 20px 50px rgba(0,0,0,0.35);
      padding:14px;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 6px 12px 6px;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      margin-bottom:10px;
    }
    .modalHeader h2{ margin:0; font-size:16px; letter-spacing:-0.3px; }
    .grid2{
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap:12px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
    }
    .box{
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,255,255,0.04);
    }
    .box h3{
      margin:0 0 8px 0;
      font-size:13px;
      color: rgba(255,255,255,0.86);
      letter-spacing:-0.2px;
    }
    .list{ display:flex; flex-direction:column; gap:8px; }
    .itemRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.20);
    }
    .itemRow .name{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .itemRow .name b{
      font-size:13px;
      letter-spacing:-0.2px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .itemRow .name span{
      font-size:12px;
      color: var(--muted);
    }

    /* 디버그 */
    #debug{
      position:absolute;
      left:12px; bottom:12px;
      transform: translateY(-160px);
      width: min(560px, calc(100vw - 24px));
      z-index: 9999;
      display:none;
      padding:10px 12px;
      font-size:12px;
      color: rgba(255,255,255,0.9);
    }
    #debug pre{
      margin:8px 0 0 0;
      white-space: pre-wrap;
      word-break: break-word;
      color: rgba(255,255,255,0.82);
      line-height: 1.35;
    }

    #fatal{
      position:absolute;
      inset:12px;
      z-index: 10000;
      display:none;
      padding:14px;
      background: rgba(0,0,0,0.78);
      border: 1px solid rgba(255,106,106,0.35);
      border-radius: 18px;
      overflow:auto;
    }
    #fatal h3{
      margin:0 0 8px 0;
      color: rgba(255,106,106,0.95);
      font-size: 14px;
      letter-spacing:-0.2px;
    }
    #fatal pre{
      margin:0;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 12px;
      color: rgba(255,255,255,0.88);
      line-height: 1.45;
    }

    @media (max-width: 520px){
      .grid2{ grid-template-columns: 1fr; }
      .grid3{ grid-template-columns: 1fr; }
      .joystick{ width:128px; height:128px; }
      #debug{ transform: translateY(-176px); }
    }
  </style>
</head>

<body>
<div id="app">
  <canvas id="cv"></canvas>

  <div id="hud">
    <div class="topbar">
      <div class="panel status">
        <div class="title">보스게이트 (초안정 v4.1)</div>
        <div class="meta">
          <span id="sceneTxt">장면: 메뉴</span>
          <span id="stageTxt">스테이지: -</span>
          <span id="timerTxt">제한: -</span>
          <span id="fpsTxt">FPS: -</span>
        </div>
        <div class="meta">
          <span class="chip" id="devTxt">기기: -</span>
          <span class="chip" id="ctxTxt">CTX: -</span>
          <span class="chip warn" id="saveChip">저장: 없음</span>
          <button class="btn small ghost" id="btnDebug">디버그</button>
        </div>
      </div>

      <div class="panel btnRow">
        <button class="btn small ghost" id="btnMenu">메뉴</button>
        <button class="btn small ghost" id="btnInv">인벤</button>
        <button class="btn small" id="btnStage">스테이지</button>
        <button class="btn small bad" id="btnBoss">보스</button>
      </div>
    </div>

    <div class="toastWrap" id="toastWrap"></div>

    <div class="bottombar">
      <div class="panel joystick" id="joy">
        <div class="stick" id="stick"></div>
      </div>

      <div class="actions">
        <div class="panel col">
          <button class="btn good" id="btnAttack">공격</button>
          <button class="btn" id="btnDash">대시</button>
        </div>
        <div class="panel col">
          <button class="btn small" id="btnToggleTarget">오토 타겟</button>
          <button class="btn small" id="btnToggleAtk">오토 공격</button>
          <button class="btn small warn" id="btnQuickSave">퀵저장</button>
          <button class="btn small bad" id="btnReset">리셋</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 메뉴 모달 -->
  <div class="modal" id="menuModal">
    <div class="modalCard">
      <div class="modalHeader">
        <h2>메뉴</h2>
        <button class="btn small ghost" id="btnCloseMenu">닫기</button>
      </div>

      <div class="grid3">
        <div class="box">
          <h3>진행</h3>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn" id="btnStartStage">스테이지 1-1 시작</button>
            <button class="btn bad" id="btnStartBoss">보스 시작</button>
            <button class="btn ghost" id="btnEndRun">스테이지 종료</button>
          </div>
          <div style="margin-top:10px; font-size:12px; color:rgba(255,255,255,0.65); line-height:1.55;">
            ※ 안정판이라 연출은 단순하지만<br>
            저장/불러오기/삭제는 정상 동작.
          </div>
        </div>

        <div class="box">
          <h3>저장/삭제</h3>
          <div class="itemRow" style="margin-bottom:10px;">
            <div class="name">
              <b>저장 슬롯</b>
              <span id="saveInfo">저장 없음</span>
            </div>
            <span class="chip" id="saveBadge">EMPTY</span>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn good" id="btnSave">저장</button>
            <button class="btn" id="btnLoad">불러오기</button>
            <button class="btn bad" id="btnDeleteSave">저장삭제</button>
          </div>

          <div style="margin-top:10px; font-size:12px; color:rgba(255,255,255,0.65); line-height:1.55;">
            저장은 브라우저(localStorage)에 저장돼.<br>
            “저장삭제”는 저장 데이터 전체 삭제.
          </div>
        </div>

        <div class="box">
          <h3>옵션</h3>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn small" id="btnToggleTarget2">오토 타겟 토글</button>
            <button class="btn small" id="btnToggleAtk2">오토 공격 토글</button>
            <button class="btn small ghost" id="btnHardRefreshHint">새로고침 팁</button>
          </div>
          <div style="margin-top:10px; font-size:12px; color:rgba(255,255,255,0.65); line-height:1.55;">
            캐시가 꼬이면 모바일은 새로고침 길게 →<br>
            “캐시 비우고 강력 새로고침”이 효과적.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 인벤 모달 -->
  <div class="modal" id="invModal">
    <div class="modalCard">
      <div class="modalHeader">
        <h2>인벤토리</h2>
        <button class="btn small ghost" id="btnCloseInv">닫기</button>
      </div>
      <div class="box">
        <h3>보유 아이템</h3>
        <div class="list" id="invList"></div>
      </div>
    </div>
  </div>

  <!-- 디버그 패널 -->
  <div class="panel" id="debug">
    <b>DEBUG</b> (버튼 입력/에러/상태 로그)
    <pre id="debugLog"></pre>
  </div>

  <!-- 치명 에러 오버레이 -->
  <div id="fatal">
    <h3>실행 중 에러 발생(먹통 원인)</h3>
    <pre id="fatalText"></pre>
    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn small" id="btnHideFatal">닫기</button>
      <button class="btn small ghost" id="btnReload">새로고침</button>
    </div>
  </div>
</div>

<script>
(() => {
  "use strict";

  // ----------------- DOM -----------------
  const cv = document.getElementById("cv");
  const sceneTxt = document.getElementById("sceneTxt");
  const stageTxt = document.getElementById("stageTxt");
  const timerTxt = document.getElementById("timerTxt");
  const fpsTxt   = document.getElementById("fpsTxt");
  const devTxt   = document.getElementById("devTxt");
  const ctxTxt   = document.getElementById("ctxTxt");
  const saveChip = document.getElementById("saveChip");

  const toastWrap = document.getElementById("toastWrap");

  const btnMenu = document.getElementById("btnMenu");
  const btnInv  = document.getElementById("btnInv");
  const btnStage= document.getElementById("btnStage");
  const btnBoss = document.getElementById("btnBoss");

  const btnAttack = document.getElementById("btnAttack");
  const btnDash   = document.getElementById("btnDash");

  const btnToggleTarget = document.getElementById("btnToggleTarget");
  const btnToggleAtk    = document.getElementById("btnToggleAtk");
  const btnQuickSave    = document.getElementById("btnQuickSave");
  const btnReset        = document.getElementById("btnReset");

  const menuModal = document.getElementById("menuModal");
  const invModal  = document.getElementById("invModal");
  const btnCloseMenu = document.getElementById("btnCloseMenu");
  const btnCloseInv  = document.getElementById("btnCloseInv");

  const btnStartStage = document.getElementById("btnStartStage");
  const btnStartBoss  = document.getElementById("btnStartBoss");
  const btnEndRun     = document.getElementById("btnEndRun");

  const btnSave       = document.getElementById("btnSave");
  const btnLoad       = document.getElementById("btnLoad");
  const btnDeleteSave = document.getElementById("btnDeleteSave");
  const saveInfo      = document.getElementById("saveInfo");
  const saveBadge     = document.getElementById("saveBadge");

  const btnToggleTarget2 = document.getElementById("btnToggleTarget2");
  const btnToggleAtk2    = document.getElementById("btnToggleAtk2");
  const btnHardRefreshHint = document.getElementById("btnHardRefreshHint");

  const joy = document.getElementById("joy");
  const stick = document.getElementById("stick");

  const invList = document.getElementById("invList");

  const debugPanel = document.getElementById("debug");
  const debugLogEl = document.getElementById("debugLog");
  const btnDebug   = document.getElementById("btnDebug");

  const fatal = document.getElementById("fatal");
  const fatalText = document.getElementById("fatalText");
  const btnHideFatal = document.getElementById("btnHideFatal");
  const btnReload = document.getElementById("btnReload");

  // ----------------- 안전 로그 -----------------
  const logs = [];
  function log(s){
    const t = new Date().toISOString().slice(11,19);
    logs.push(`[${t}] ${s}`);
    while (logs.length > 18) logs.shift();
    debugLogEl.textContent = logs.join("\n");
  }

  function showFatal(msg){
    fatalText.textContent = msg;
    fatal.style.display = "block";
    log("FATAL: " + (msg.split("\n")[0] || msg));
  }

  window.addEventListener("error", (e)=>{
    const msg =
`[window.onerror]
${e.message || "unknown error"}
file: ${e.filename || "-"}
line: ${e.lineno || "-"} col: ${e.colno || "-"}
${e.error && e.error.stack ? ("\n" + e.error.stack) : ""}`;
    showFatal(msg);
  });

  window.addEventListener("unhandledrejection", (e)=>{
    const reason = (e && e.reason) ? (e.reason.stack || String(e.reason)) : "unknown rejection";
    showFatal(`[unhandledrejection]\n${reason}`);
  });

  btnHideFatal.addEventListener("click", ()=> fatal.style.display="none");
  btnReload.addEventListener("click", ()=> location.reload());

  // ----------------- 유틸 -----------------
  const clamp = (v,a,b)=> Math.max(a, Math.min(b,v));
  const now = ()=> performance.now();

  function isMobileLike(){
    return (navigator.maxTouchPoints || 0) > 0 || matchMedia("(pointer: coarse)").matches;
  }
  devTxt.textContent = `기기: ${isMobileLike() ? "스마트폰/태블릿" : "PC"}`;

  // ----------------- 토스트 -----------------
  const toasts = [];
  function toast(html, life=1200){
    const el = document.createElement("div");
    el.className = "toast";
    el.innerHTML = html;
    toastWrap.appendChild(el);
    requestAnimationFrame(()=> el.classList.add("show"));
    toasts.push({ el, die: now()+life });
    log("TOAST: " + el.textContent.trim());
  }
  function updateToasts(){
    const t = now();
    for (let i=toasts.length-1;i>=0;i--){
      if (t > toasts[i].die){
        const el = toasts[i].el;
        el.classList.remove("show");
        setTimeout(()=> el.remove(), 220);
        toasts.splice(i,1);
      }
    }
  }

  // ----------------- 클릭/터치 안정 바인딩 -----------------
  function bind(btn, name, fn){
    const run = (e)=>{
      try{
        if (e && e.cancelable) e.preventDefault();
        log(`BTN: ${name}`);
        fn();
      }catch(err){
        showFatal(`[bind:${name}]\n${err && err.stack ? err.stack : String(err)}`);
      }
    };
    btn.addEventListener("click", run, { passive:false });
    btn.addEventListener("touchstart", run, { passive:false });
    btn.addEventListener("pointerdown", run, { passive:false });
  }

  // ----------------- 캔버스 -----------------
  const ctx = (() => {
    try{
      const c = cv.getContext("2d", { alpha:false });
      ctxTxt.textContent = c ? "CTX: 2D OK" : "CTX: FAIL";
      return c;
    }catch(_){
      ctxTxt.textContent = "CTX: FAIL";
      return null;
    }
  })();

  if (!ctx){
    showFatal("Canvas 2D 컨텍스트 생성 실패.\n브라우저 호환/설정 문제 가능.");
    return;
  }

  function resize(){
    const dpr = Math.min(2, Math.max(1, window.devicePixelRatio || 1));
    const w = Math.max(1, window.innerWidth);
    const h = Math.max(1, window.innerHeight);
    cv.width  = Math.floor(w * dpr);
    cv.height = Math.floor(h * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    log(`resize: ${w}x${h} dpr=${dpr}`);
  }
  window.addEventListener("resize", resize, { passive:true });
  resize();

  // ----------------- 게임 상태(초단순) -----------------
  const Game = {
    scene: "menu",     // menu / stage / boss
    stageId: null,
    stageTime: 0,
    timeLimit: 0,
    autoTarget: true,
    autoAttack: true,
  };

  const Player = {
    x: 0, y: 0,
    r: 14,
    spd: 220,
    atk: 14,
    dashTime: 0,
    dashCd: 0,
  };

  const Mobs = []; // {kind,x,y,r,hp,hpMax,phase}

  // 인벤(표시만)
  const Inv = [
    { name:"미감정 장비", desc:"기본공격 +3 (잠재: 미공개)" },
    { name:"미감정 장비", desc:"기본공격 +2 (잠재: 미공개)" },
  ];

  function setScene(scene, stageId=null, limit=0){
    Game.scene = scene;
    Game.stageId = stageId;
    Game.stageTime = 0;
    Game.timeLimit = limit;
    Mobs.length = 0;
    Player.x = 0; Player.y = 0;
    Player.dashTime = 0; Player.dashCd = 0;

    if (scene === "stage"){
      for (let i=0;i<6;i++){
        const elite = Math.random()<0.2;
        Mobs.push({
          kind: elite?"elite":"slime",
          x:(Math.random()*2-1)*220,
          y:(Math.random()*2-1)*140,
          r: elite?18:14,
          hp: elite?90:45,
          hpMax: elite?90:45,
          phase: Math.random()*Math.PI*2
        });
      }
    } else if (scene === "boss"){
      Mobs.push({ kind:"boss", x: 220, y: 0, r: 34, hp:260, hpMax:260, phase: Math.random()*Math.PI*2 });
    }
    syncHUD();
  }

  function syncHUD(){
    sceneTxt.textContent = `장면: ${Game.scene==="menu" ? "메뉴" : (Game.scene==="stage" ? "스테이지" : "보스")}`;
    stageTxt.textContent = `스테이지: ${Game.stageId ?? "-"}`;
  }

  // ----------------- 인벤 UI -----------------
  function openInv(){
    invList.innerHTML = "";
    for (const it of Inv){
      const row = document.createElement("div");
      row.className = "itemRow";
      row.innerHTML = `
        <div class="name">
          <b>${it.name}</b>
          <span>${it.desc}</span>
        </div>
        <span class="chip">보유</span>
      `;
      invList.appendChild(row);
    }
    invModal.classList.add("show");
  }

  // ----------------- 모달 -----------------
  function closeAll(){
    menuModal.classList.remove("show");
    invModal.classList.remove("show");
  }

  // ----------------- 저장 시스템(localStorage) -----------------
  const SAVE_KEY = "bossgate_save_v4_1";

  function safeJSONParse(s){
    try{ return JSON.parse(s); }catch(_){ return null; }
  }

  function snapshot(){
    // 깊은 복사(간단)
    return {
      v: "4.1",
      savedAt: Date.now(),
      game: { ...Game },
      player: { ...Player },
      mobs: Mobs.map(m => ({...m})),
      inv: Inv.map(i => ({...i}))
    };
  }

  function applySnapshot(data){
    if (!data || !data.game || !data.player) throw new Error("저장 데이터 형식이 올바르지 않음");

    Game.scene = data.game.scene ?? "menu";
    Game.stageId = data.game.stageId ?? null;
    Game.stageTime = Number(data.game.stageTime ?? 0) || 0;
    Game.timeLimit = Number(data.game.timeLimit ?? 0) || 0;
    Game.autoTarget = !!data.game.autoTarget;
    Game.autoAttack = !!data.game.autoAttack;

    Player.x = Number(data.player.x ?? 0) || 0;
    Player.y = Number(data.player.y ?? 0) || 0;
    Player.r = Number(data.player.r ?? 14) || 14;
    Player.spd = Number(data.player.spd ?? 220) || 220;
    Player.atk = Number(data.player.atk ?? 14) || 14;
    Player.dashTime = Number(data.player.dashTime ?? 0) || 0;
    Player.dashCd = Number(data.player.dashCd ?? 0) || 0;

    Mobs.length = 0;
    if (Array.isArray(data.mobs)){
      for (const m of data.mobs){
        if (!m) continue;
        Mobs.push({
          kind: m.kind || "slime",
          x: Number(m.x ?? 0) || 0,
          y: Number(m.y ?? 0) || 0,
          r: Number(m.r ?? 14) || 14,
          hp: Number(m.hp ?? 45) || 45,
          hpMax: Number(m.hpMax ?? 45) || 45,
          phase: Number(m.phase ?? 0) || 0,
        });
      }
    }

    Inv.length = 0;
    if (Array.isArray(data.inv)){
      for (const i of data.inv){
        if (!i) continue;
        Inv.push({ name: String(i.name ?? "아이템"), desc: String(i.desc ?? "") });
      }
    }

    // 버튼 상태 동기화
    btnToggleTarget.classList.toggle("on", Game.autoTarget);
    btnToggleAtk.classList.toggle("on", Game.autoAttack);

    syncHUD();
  }

  function getSaveMeta(){
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return null;
    const data = safeJSONParse(raw);
    if (!data || !data.savedAt) return null;
    return {
      savedAt: data.savedAt,
      scene: data.game?.scene ?? "menu",
      stageId: data.game?.stageId ?? "-",
      v: data.v ?? "-"
    };
  }

  function fmtTime(ts){
    const d = new Date(ts);
    const yy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    return `${yy}-${mm}-${dd} ${hh}:${mi}`;
  }

  function refreshSaveUI(){
    const meta = getSaveMeta();
    if (!meta){
      saveChip.textContent = "저장: 없음";
      saveChip.classList.remove("good","bad"); saveChip.classList.add("warn");
      saveInfo.textContent = "저장 없음";
      saveBadge.textContent = "EMPTY";
      saveBadge.className = "chip";
      return;
    }
    saveChip.textContent = `저장: ${fmtTime(meta.savedAt)}`;
    saveChip.classList.remove("warn","bad"); saveChip.classList.add("good");

    saveInfo.textContent = `${fmtTime(meta.savedAt)} · 장면:${meta.scene} · 스테이지:${meta.stageId}`;
    saveBadge.textContent = "SAVED";
    saveBadge.className = "chip good";
  }

  function doSave(){
    const data = snapshot();
    localStorage.setItem(SAVE_KEY, JSON.stringify(data));
    refreshSaveUI();
    toast("<b>저장 완료</b>", 1100);
  }

  function doLoad(){
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw){
      toast("<b>저장 데이터 없음</b>", 1100);
      return;
    }
    const data = safeJSONParse(raw);
    if (!data){
      toast("<b>저장 데이터 손상</b>", 1100);
      return;
    }
    applySnapshot(data);
    refreshSaveUI();
    toast("<b>불러오기 완료</b>", 1100);
    closeAll();
  }

  function doDeleteSave(){
    localStorage.removeItem(SAVE_KEY);
    refreshSaveUI();
    toast("<b>저장삭제 완료</b>", 1100);
  }

  // ----------------- 버튼 동작 -----------------
  bind(btnMenu, "메뉴", ()=>{ menuModal.classList.toggle("show"); invModal.classList.remove("show"); refreshSaveUI(); toast("<b>메뉴</b> 열림", 900); });
  bind(btnInv,  "인벤", ()=>{ menuModal.classList.remove("show"); openInv(); toast("<b>인벤</b> 열림", 900); });

  bind(btnStage,"스테이지", ()=>{ setScene("stage","1-1",300); toast("<b>스테이지 1-1</b> 시작", 1100); closeAll(); });
  bind(btnBoss, "보스", ()=>{ setScene("boss","BOSS",240); toast("<b>보스전</b> 시작", 1100); closeAll(); });

  bind(btnCloseMenu,"메뉴닫기", ()=> menuModal.classList.remove("show"));
  bind(btnCloseInv, "인벤닫기", ()=> invModal.classList.remove("show"));

  bind(btnStartStage,"메뉴:스테이지시작", ()=>{ setScene("stage","1-1",300); toast("<b>스테이지 1-1</b> 시작", 1100); closeAll(); });
  bind(btnStartBoss, "메뉴:보스시작", ()=>{ setScene("boss","BOSS",240); toast("<b>보스전</b> 시작", 1100); closeAll(); });
  bind(btnEndRun,    "스테이지종료", ()=>{ setScene("menu",null,0); toast("종료(데모)", 900); closeAll(); });

  bind(btnAttack,"공격", ()=>{ toast("공격!", 600); });
  bind(btnDash,  "대시", ()=>{ Player.dashTime = 0.12; Player.dashCd = 0.8; toast("대시!", 600); });

  function toggleTarget(){
    Game.autoTarget = !Game.autoTarget;
    btnToggleTarget.classList.toggle("on", Game.autoTarget);
    toast(`오토 타겟: <b>${Game.autoTarget?"ON":"OFF"}</b>`, 900);
  }
  function toggleAtk(){
    Game.autoAttack = !Game.autoAttack;
    btnToggleAtk.classList.toggle("on", Game.autoAttack);
    toast(`오토 공격: <b>${Game.autoAttack?"ON":"OFF"}</b>`, 900);
  }

  bind(btnToggleTarget,"오토타겟", toggleTarget);
  bind(btnToggleAtk,   "오토공격", toggleAtk);
  bind(btnToggleTarget2,"오토타겟(메뉴)", toggleTarget);
  bind(btnToggleAtk2,   "오토공격(메뉴)", toggleAtk);

  bind(btnQuickSave, "퀵저장", ()=> doSave());
  bind(btnReset,     "리셋", ()=>{ setScene("menu",null,0); toast("<b>리셋</b> 완료", 900); closeAll(); });

  bind(btnSave,       "저장", ()=> doSave());
  bind(btnLoad,       "불러오기", ()=> doLoad());
  bind(btnDeleteSave, "저장삭제", ()=> doDeleteSave());

  bind(btnHardRefreshHint, "새로고침팁", ()=>{
    toast("모바일: 새로고침 길게 → <b>캐시 비우고 강력 새로고침</b>", 1600);
  });

  bind(btnDebug, "디버그", ()=>{
    const on = debugPanel.style.display !== "block";
    debugPanel.style.display = on ? "block" : "none";
    toast(on ? "DEBUG ON" : "DEBUG OFF", 700);
  });

  // ----------------- 조이스틱 -----------------
  const Joy = { active:false, id:null, cx:0, cy:0, x:0, y:0, maxR:52 };

  function resetStick(){
    stick.style.transform = "translate(-50%,-50%)";
  }
  function setStick(dx,dy){
    const r = Math.hypot(dx,dy);
    let sx=dx, sy=dy;
    if (r > Joy.maxR){
      const k = Joy.maxR / r;
      sx*=k; sy*=k;
    }
    stick.style.transform = `translate(calc(-50% + ${sx}px), calc(-50% + ${sy}px))`;
  }

  joy.addEventListener("pointerdown", (e)=>{
    if (e.cancelable) e.preventDefault();
    Joy.active = true;
    Joy.id = e.pointerId;
    const rect = joy.getBoundingClientRect();
    Joy.cx = rect.left + rect.width/2;
    Joy.cy = rect.top  + rect.height/2;
    const dx = e.clientX - Joy.cx;
    const dy = e.clientY - Joy.cy;
    setStick(dx,dy);
    Joy.x = clamp(dx/Joy.maxR, -1, 1);
    Joy.y = clamp(dy/Joy.maxR, -1, 1);
  }, { passive:false });

  joy.addEventListener("pointermove", (e)=>{
    if (!Joy.active || e.pointerId !== Joy.id) return;
    if (e.cancelable) e.preventDefault();
    const dx = e.clientX - Joy.cx;
    const dy = e.clientY - Joy.cy;
    setStick(dx,dy);
    Joy.x = clamp(dx/Joy.maxR, -1, 1);
    Joy.y = clamp(dy/Joy.maxR, -1, 1);
  }, { passive:false });

  function endJoy(e){
    if (!Joy.active) return;
    if (e && e.pointerId !== Joy.id) return;
    Joy.active = false;
    Joy.id = null;
    Joy.x = 0; Joy.y = 0;
    resetStick();
  }
  joy.addEventListener("pointerup", endJoy, { passive:false });
  joy.addEventListener("pointercancel", endJoy, { passive:false });

  // ----------------- 루프(무조건 그리기) -----------------
  let last = now();
  let fpsAcc=0, fpsFrames=0, fps=60;

  function update(dt){
    // 타이머
    if (Game.scene !== "menu"){
      Game.stageTime += dt;
      const left = Math.max(0, Math.ceil(Game.timeLimit - Game.stageTime));
      const mm = String(Math.floor(left/60)).padStart(2,"0");
      const ss = String(left%60).padStart(2,"0");
      timerTxt.textContent = `제한: ${mm}:${ss}`;
      if (left <= 0){
        setScene("menu",null,0);
        toast("<b>시간 초과</b> 종료", 1200);
      }
    } else {
      timerTxt.textContent = "제한: -";
    }

    // 이동
    const mx = Joy.active ? Joy.x : 0;
    const my = Joy.active ? Joy.y : 0;
    const len = Math.hypot(mx,my);
    const nx = len>1e-6 ? mx/len : 0;
    const ny = len>1e-6 ? my/len : 0;

    const spd = Player.spd * (Player.dashTime>0 ? 2.4 : 1.0);
    Player.x += nx * spd * dt;
    Player.y += ny * spd * dt;

    Player.dashTime = Math.max(0, Player.dashTime - dt);
    Player.dashCd   = Math.max(0, Player.dashCd - dt);

    // 몬스터 “살아있다” 표시
    for (const m of Mobs){
      m.phase += dt * (m.kind==="boss" ? 1.2 : 1.8);
    }
  }

  function draw(){
    const w = window.innerWidth;
    const h = window.innerHeight;

    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = "rgba(0,0,0,0.25)";
    ctx.fillRect(0,0,w,h);

    ctx.save();
    ctx.translate(w/2, h/2);

    // 안내 텍스트
    ctx.fillStyle = "rgba(255,255,255,0.82)";
    ctx.font = "700 16px system-ui, sans-serif";
    ctx.textAlign = "left";
    ctx.textBaseline = "top";
    ctx.fillText("보스게이트 v4.1 - 저장/불러오기/저장삭제 메뉴 포함", -w/2 + 16, -h/2 + 16);

    // 몬스터
    for (const m of Mobs){
      const wob = Math.sin(m.phase) * 2.2;
      ctx.fillStyle =
        m.kind==="boss" ? "rgba(255,106,106,0.92)" :
        m.kind==="elite"? "rgba(106,167,255,0.92)" :
                          "rgba(106,227,123,0.92)";
      ctx.beginPath();
      ctx.arc(m.x, m.y + wob, m.r, 0, Math.PI*2);
      ctx.fill();
    }

    // 플레이어
    ctx.fillStyle = "rgba(255,255,255,0.95)";
    ctx.beginPath();
    ctx.arc(Player.x, Player.y, Player.r, 0, Math.PI*2);
    ctx.fill();

    ctx.restore();
  }

  function loop(){
    const t = now();
    let dt = (t - last) / 1000;
    last = t;
    dt = Math.min(0.05, Math.max(0, dt));

    fpsAcc += dt; fpsFrames++;
    if (fpsAcc >= 0.4){
      fps = Math.round(fpsFrames / fpsAcc);
      fpsAcc = 0; fpsFrames = 0;
      fpsTxt.textContent = `FPS: ${fps}`;
    }

    update(dt);
    draw();
    updateToasts();
    requestAnimationFrame(loop);
  }

  // ----------------- 시작 -----------------
  btnToggleTarget.classList.toggle("on", Game.autoTarget);
  btnToggleAtk.classList.toggle("on", Game.autoAttack);

  setScene("menu", null, 0);
  refreshSaveUI();

  toast("<b>v4.1</b> 로딩 완료", 1200);
  toast("메뉴에 <b>저장/불러오기/저장삭제</b> 추가됨", 1400);

  log("init ok");
  loop();
})();
</script>
</body>
</html>
